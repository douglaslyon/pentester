#include "Arduino.h"
#include "PENTEST_KEYBOARD.h"

 
  /****************** kEYBOARD FUNCTIONS ***************************/

void typeKey(int key) {
  Keyboard.press(key);
  delay(defaultCharDelay);
  Keyboard.release(key);
}

void windowsOpen(String app){
      delay(defaultDelay);
      delay(defaultDelay);
      Keyboard.press(KEY_LEFT_GUI);
      Keyboard.press(114);
      Keyboard.releaseAll();

      delay(defaultDelay);
      delay(200);

      delay(defaultDelay);
      Keyboard.print(app);

      delay(defaultDelay);
      typeKey(KEY_RETURN);
      delay(100);
}


void openCMD() {
  delay(defaultDelay);
  switch (OS) {
    case 'W':
      windowsOpen("cmd");
    case 'L':    
      Keyboard.press(KEY_LEFT_ALT);
      delay(defaultDelay);
      Keyboard.press(KEY_LEFT_CTRL);
      delay(defaultDelay);
      Keyboard.press('t');
      delay(defaultDelay);
      Keyboard.releaseAll();
      delay(200);

      break;


    case 'M':    // Mac OS run dialog
      delay(defaultDelay);
      Keyboard.press(KEY_LEFT_GUI);
      Keyboard.press(' '); //cmd + N opens new terminal window, cmd + space opens spotlight search
      Keyboard.releaseAll();
      delay(600);
      Keyboard.print("Terminal");
      delay(200);
      typeKey(KEY_RETURN);
      Keyboard.releaseAll();
      delay(defaultDelay);
      delay(200);
      break;
  }

}

String readPayload(byte payload[]){
  String com = String((char*)payload);
  return com; 
}

char typeCommands(byte payload[]) {
  int i = 0;
  String com = readPayload(payload);
  Serial.println(com);
  while (com[i] != '\0'){
    if (com[i]=='@'){
      ++i; 
      Serial.print("Exectuting special ");
      Serial.println(com[i]);
      executeSpecialCommand(com[i]);
      ++i;
    }
    Keyboard.write(com[i]);
    ++i;
  }  
  com = "";
  typeKey(KEY_RETURN);
  Keyboard.releaseAll();
}

void executeSpecialCommand(byte command){

  switch (command)
  {
  case '1':
    setOS('W');
    openCMD();
    break;
  
  case '2':
    setOS('L');
    openCMD();
    break;
  case '3':
    setOS('M');
    openCMD();
    break;
  
  } 
}

void setOS(char operatingSystem){
  OS = operatingSystem;
}
